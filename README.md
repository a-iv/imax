Проект предназначен для передачи данных с зарядных устройств SkyRC iMAX B6AC V2,
подключенных через шатный USB порт, в популярную программу для сбора и анализа логов LogView V2.

Должен работать на SkyRC iMAX B6 Mini. Однако работа с реальным устройство не проверялась.

Историческая справка
====================

LogView успешно используется для построения графиков зарядки и разрядки аккумуляторных батарей различными устройствами.
Для подключения iMAX B6 интузиасты использовали самодельные переходники, подключая выходы термодатчика iMAX к COM порту.
iMAX B6AC V2 и B6 Mini обладают штатным micro-USB портом. Однако в качестве интерфейса теперь используется USB HID.
Формат передачи данных также был изменен.

Покупая iMAX B6AC V2 я был уверен, что смогу передавать данные в LogView.
Однако из коробки в LogView V2 отсутствует настройки для iMAX B6AC V2 и B6 Mini. А настройки для других iMAX требуют
указания COM порта, которого просто нет.
Более новая версия LogView Studio позволяет выбрать iMAX B6AC V2 и указать USB HID устройство. Оно отправляет запросы к
iMax и получает ответы. Однако не видит полезных данных.

Больше суток моей жизни ушли на эксперименты и поиск информации чтобы понять, что я делаю всё верно и LogView на новых
устройствах из коробки действитель ничего не видет.

Потом ещё сутки ушли на поиск информации о настройке LogView и на тщетные самостоятельные попытки. Дело в том, что в
2014 году поддержка программы прекралисаль. А все темы, по моей теме на различных форумах и языках просто остаются без
ответа. От отчаяния люди заняли реверсинженирингом и тихонечко для себя делают программы для получения данных, а иногда
даже для визуализации. А кто-то вообще делает другие прошивки с поддержкой LogView:

* https://github.com/GaryDyr/imaxcharger
* https://github.com/Milek7/imax-b6mini-datalogger
* https://github.com/fornellas/skyrcimaxb6ac
* http://forum.rcdesign.ru/f88/thread206470-47.html#post6712482
* https://github.com/stawel/cheali-charger

К слову сказать по первой ссылке можно найти очень много полезной информации.

Такие варианты меня не устроили, я хотел как бородатые мужики использовать LogView.
Тем более на создание решения у меня ушло значительно меньше времени, чем на предыдущие этапы.

Принцип работы
==============

Приложение постоянно опрашивает iMAX через USB HID и из полученного ответа достаёт полезные данные.
Оформляет их в соответствии с форматом OpenFormat и отправляет в витруальный COM порт.
C помощью null-modem emulator данные из этого порта отправляются в другой витруальный COM порт,
который уже читает LogView в формате iMAX B6AC.

Два виртуальных потра необходимы, так как две программы не могут взаимодействовать друг с другом через один COM порт.

Установка и настройка
=====================

Null-modem emulator
-------------------

1. Скачать Null-modem emulator (тестировалось на версии 3.0.0.0): https://sourceforge.net/projects/com0com/
2. Установить приложение. За ненадобностью при установке можно отключить `CNCA0 <-> CNCB0`.
3. Запустить и запомнить номара первого и второго созданного виртуального порта.
При необходимости можно изменить номера портов и нажать на кнопку `Apply`.
4. Приложение можно закрыть. Для его работы ничего запускать не потребуется.

iMAX B6AC V2 LogView Proxy
--------------------------

1. Подключить iMax B6AC V2 через USB к ПК.
2. Запустить приложение.
3. Открыть созданный `proxy.ini` в блокноте.
4. Указать числовой номер первого виртуального порта, позданного в Null-modem emelator (у меня: `port_number = 3`).
5. Сохранить изменения.
6. Запустить приложение.
7. Проверить появление окна с текстом `INFO: New state: user stop`.
8. Через экран iMAX запустить необходимый процесс (например, разрядку).
9. Проверить появление в окне текста `INFO: New state: running`.

После корректного завершения процесса должно появиться `INFO: New state: imax finish`.

LogView V2
----------

1. Скачать и установить LogView V2 (тестировалось на версии 2.7.6.511):
http://logview.info/forum/index.php?resources/logview-v2.1/
2. Запусить LogView.
3. Выбрать язык, не выбирать порт и устройство, остальные настройки выбрать по вашему усмотрению.
4. Скопировать `OpenFormat.ini` и `OpenFormat.jpg` из папки iMAX B6AC V2 LogView Proxy в `%AppData%\LogView\Geraete\`.
5. Скопировать `OpenFormat.lvt` из папки iMAX B6AC V2 LogView Proxy в `%AppData%\LogView\Templates Grafik\`.
6. Выбрать пункт меню `Device` → `Choose device and port`.
7. В поле `Device` выбрать `OpenFormat`, а в `Connection port` выбрать второй виртуальный порт (у меня `COM4`).
8. При желании можно включить `Automatic start recording`.
9. Нажать `Close`.
10. Выбрать пункт меню `Device` → `Open port / recording`.
11. При желании можно выбрать пункт меню `Graph` → `Open draft graph` и открыть `OpenFormat.lvt`.

LogView Studio
--------------

1. В папке iMAX B6AC V2 LogView Proxy открыть `proxy.ini` в блокноте.
2. Вместо `use_studio = False` указать `use_studio = True`.
3. Сохранить изменения.
4. Перезапустить приложение.
5. Скачать и установить LogView Studio (тестировалось на версии 1.0.3662.0903):
http://www.logview.info/forum/index.php?resources/logview-studio.9/
6. Запусить LogView.
7. Нажать `New Project`.
8. Выбрать папку, внутри которой будет создан проект.
9. Нажать на кнонку папки с плюсом справа.
10. Указать имя проекта.
11. Нажать `OK`.
12. Нажать `Finish`.
13. Нажать на кнопку `Device`.
13. В выпадающем списке выбрать `OpenFormat INI`.
14. Нажать `Source`.
15. В выпадающем списке выбрать второй виртуальный порт (у меня `COM4`).
16. Нажать `OK`.
17. Рядом с `OpenFormat INI` включить флажок.
18. В открывшееся окно вставить полный путь до `OpenFormat.ini`. Никогда не оставляйте это поле пустым.
19. Нажать `OK`.
20. Выбрать `Channel` и нажать на кнопку `Chart`.

Чтобы каждый раз не указывать путь до `OpenFormat.ini`, его можно скопировать в папку установки приложения
(у меня `C:\Program Files (x86)\LogView Studio`).

Если не работает
================

1. Проверить, что ChargeMaster v2 видит iMAX B6AC V2.
2. Проверить, что в диспетчере устройств в разделе `Устройства HID (Human Interface Devices)` при подключении iMAX
появляются `HID-совместимое устройство` и `USB-устройство ввода`. 
3. Проверить, что в диспетчере устройств в разделе `Порты (COM и LPT)` отображается оба виртуальных порта `com0com`.
4. В LogView V2 в нижней части экрана открыть `Serial logging` и убедиться в получении данных.
5. В LogView Studio выбрать `OpenFormat INI`, нажать `Device monitoring` и убедиться в получении данных.

Запуск из исходников
====================

1. Установить Python 3 (у меня Python 3.4.4 64bit из https://www.python.org/downloads/release/python-344/).
2. `pip install -r requirements.txt`
3. `python proxy.py`

Сборка бинарного файла
======================

1. `pip install -r py2exe`
2. `build_exe --bundle-files 1 --dest . proxy.py`

К сожалению py2exe 0.9.2.2 отказался собирать бинарный файл на Python 3.6.2. Поэтому я воспользовался Python 3.4.4.
